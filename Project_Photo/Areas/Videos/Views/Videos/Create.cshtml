@model Project_Photo.Areas.Videos.Models.Video
@{
	ViewData["Title"] = "Create";
}
@section Styles {
	<style>
		* {
			box-sizing: border-box;
		}

		.container {
			max-width: 900px;
			margin: 0 auto;
			padding: 20px;
		}

		.warning-banner {
			display: none;
			background: #ff9800;
			color: white;
			padding: 15px;
			text-align: center;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			z-index: 1000;
			font-weight: bold;
			box-shadow: 0 2px 8px rgba(0,0,0,0.2);
		}

		h1 {
			color: #333;
			margin-bottom: 30px;
		}

		.upload-container {
			border: 2px dashed #ccc;
			border-radius: 8px;
			padding: 60px 40px;
			text-align: center;
			background: #f9f9f9;
			transition: all 0.3s;
		}

			.upload-container.dragover {
				background: #e3f2fd;
				border-color: #2196F3;
				transform: scale(1.02);
			}

			.upload-container p {
				margin: 10px 0;
				color: #666;
			}

		input[type="file"] {
			display: none;
		}

		.upload-btn {
			background: #2196F3;
			color: white;
			padding: 12px 32px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: background 0.3s;
		}

			.upload-btn:hover {
				background: #1976D2;
			}

		.progress-container {
			display: none;
			margin-top: 30px;
		}

		.progress-bar {
			width: 100%;
			height: 30px;
			background: #e0e0e0;
			border-radius: 15px;
			overflow: hidden;
		}

		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #4CAF50, #66BB6A);
			width: 0%;
			transition: width 0.3s;
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: bold;
		}

		.status-message {
			margin-top: 15px;
			padding: 12px;
			border-radius: 4px;
			text-align: center;
		}

		.status-success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}

		.status-error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}

		.status-warning {
			background: #fff3cd;
			color: #856404;
			border: 1px solid #ffeaa7;
		}

		.status-info {
			background: #d1ecf1;
			color: #0c5460;
			border: 1px solid #bee5eb;
		}

		.video-preview-section {
			display: none;
			margin-top: 30px;
		}

		.preview-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
		}

			.preview-header h3 {
				margin: 0;
				color: #333;
			}

		.video-preview {
			margin-bottom: 30px;
		}

			.video-preview video {
				width: 100%;
				max-height: 400px;
				border-radius: 8px;
				background: #000;
			}

		.thumbnail-section {
			margin-top: 30px;
			padding: 20px;
			background: #f5f5f5;
			border-radius: 8px;
		}

			.thumbnail-section h4 {
				margin-top: 0;
				color: #333;
			}

		.thumbnail-options {
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
			margin-top: 15px;
		}

		.thumbnail-item {
			flex: 0 0 calc(33.333% - 10px);
			position: relative;
			cursor: pointer;
			border: 3px solid transparent;
			border-radius: 8px;
			overflow: hidden;
			transition: all 0.3s;
		}

			.thumbnail-item:hover {
				transform: scale(1.05);
			}

			.thumbnail-item.selected {
				border-color: #2196F3;
				box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
			}

			.thumbnail-item img {
				width: 100%;
				height: 120px;
				object-fit: cover;
				display: block;
			}

			.thumbnail-item .check-icon {
				position: absolute;
				top: 5px;
				right: 5px;
				background: #2196F3;
				color: white;
				width: 24px;
				height: 24px;
				border-radius: 50%;
				display: none;
				align-items: center;
				justify-content: center;
				font-size: 14px;
			}

			.thumbnail-item.selected .check-icon {
				display: flex;
			}

		.custom-thumbnail-upload {
			flex: 0 0 calc(33.333% - 10px);
			height: 120px;
			border: 2px dashed #ccc;
			border-radius: 8px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: all 0.3s;
			background: white;
		}

			.custom-thumbnail-upload:hover {
				border-color: #2196F3;
				background: #f0f8ff;
			}

			.custom-thumbnail-upload svg {
				width: 32px;
				height: 32px;
				color: #666;
				margin-bottom: 8px;
			}

		.form-section {
			margin-top: 30px;
		}

		.form-grid {
			display: grid;
			gap: 20px;
		}

		.form-group {
			text-align: left;
		}

			.form-group label {
				display: block;
				margin-bottom: 8px;
				font-weight: bold;
				color: #333;
			}

			.form-group input,
			.form-group textarea,
			.form-group select {
				width: 100%;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				font-size: 14px;
				transition: border-color 0.3s;
			}

				.form-group input:focus,
				.form-group textarea:focus,
				.form-group select:focus {
					outline: none;
					border-color: #2196F3;
				}

			.form-group textarea {
				min-height: 100px;
				resize: vertical;
			}

			.form-group small {
				display: block;
				margin-top: 5px;
				color: #666;
				font-size: 13px;
			}

		.privacy-options {
			display: flex;
			gap: 10px;
			margin-top: 10px;
		}

		.privacy-option {
			flex: 1;
			padding: 12px;
			border: 2px solid #ddd;
			border-radius: 4px;
			cursor: pointer;
			text-align: center;
			transition: all 0.3s;
		}

			.privacy-option:hover {
				border-color: #2196F3;
				background: #f0f8ff;
			}

			.privacy-option.selected {
				border-color: #2196F3;
				background: #e3f2fd;
			}

			.privacy-option input[type="radio"] {
				display: none;
			}

			.privacy-option .icon {
				font-size: 24px;
				margin-bottom: 5px;
			}

			.privacy-option .label {
				font-weight: bold;
				color: #333;
			}

			.privacy-option .description {
				font-size: 12px;
				color: #666;
				margin-top: 3px;
			}

		.action-buttons {
			display: flex;
			gap: 15px;
			margin-top: 30px;
		}

		.btn {
			flex: 1;
			padding: 14px 24px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s;
		}

		.btn-primary {
			background: #4CAF50;
			color: white;
		}

			.btn-primary:hover:not(:disabled) {
				background: #45a049;
			}

		.btn-secondary {
			background: #f5f5f5;
			color: #333;
			border: 1px solid #ddd;
		}

			.btn-secondary:hover:not(:disabled) {
				background: #e0e0e0;
			}

		.btn:disabled {
			background: #cccccc;
			cursor: not-allowed;
			opacity: 0.6;
		}

		/* media (max-width: 768px) {
			.thumbnail-item, .custom-thumbnail-upload

		{
			flex: 0 0 calc(50% - 7.5px);
		}

		.action-buttons {
			flex-direction: column;
		}

		.privacy-options {
			flex-direction: column;
		}

		} */
	</style>
}

<div class="warning-banner" id="warningBanner">
	âš ï¸ å½±ç‰‡ä¸Šå‚³ä¸­ï¼Œè«‹å‹¿é—œé–‰æ­¤é é¢ï¼
</div>

<div class="container">
	<h1>ä¸Šå‚³å½±ç‰‡</h1>

	<div class="upload-container" id="uploadContainer">
		<p style="font-size: 18px; margin-bottom: 5px;">ğŸ“¹ æ‹–æ”¾å½±ç‰‡æª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–</p>
		<button class="upload-btn" onclick="document.getElementById('fileInput').click()">
			é¸æ“‡æª”æ¡ˆ
		</button>
		<input type="file" id="fileInput" accept="video/*">
		<p style="font-size: 14px; margin-top: 15px;">
			æ”¯æ´æ ¼å¼: MP4, AVI, MOV (æœ€å¤§ 500MB)
		</p>
	</div>

	<div class="progress-container" id="progressContainer">
		<div class="progress-bar">
			<div class="progress-fill" id="progressFill">0%</div>
		</div>
		<div id="statusMessage"></div>
	</div>

	<div class="video-preview-section" id="videoPreviewSection">
		<div class="preview-header">
			<h3>å½±ç‰‡è©³ç´°è³‡è¨Š</h3>
		</div>

		<div class="video-preview">
			<video id="previewVideo" controls></video>
		</div>

		<!-- ç¸®åœ–é¸æ“‡å€ -->
		<div class="thumbnail-section">
			<h4>é¸æ“‡ç¸®åœ–</h4>
			<div class="thumbnail-options" id="thumbnailOptions">
				<!-- è‡ªå‹•ç”Ÿæˆçš„ç¸®åœ–æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
			</div>
			<input type="file" id="customThumbnailInput" accept="image/*" style="display: none;">
		</div>

		<!-- è¡¨å–®å€ -->
		<div class="form-section">
			<div class="form-grid">
				<div class="form-group">
					<label for="videoTitle">å½±ç‰‡æ¨™é¡Œ *</label>
					<input type="text" id="videoTitle" required placeholder="è¼¸å…¥å¸å¼•äººçš„æ¨™é¡Œ" maxlength="100">
					<small>0/100 å­—å…ƒ</small>
				</div>

				<div class="form-group">
					<label for="videoDescription">å½±ç‰‡æè¿°</label>
					<textarea id="videoDescription" placeholder="æè¿°æ‚¨çš„å½±ç‰‡å…§å®¹..." maxlength="5000"></textarea>
					<small>0/5000 å­—å…ƒ</small>
				</div>

				<div class="form-group">
					<label>éš±ç§è¨­å®š *</label>
					<div class="privacy-options">
						<label class="privacy-option selected" data-value="Public">
							<input type="radio" name="privacy" value="Public" checked>
							<div class="icon">ğŸŒ</div>
							<div class="label">å…¬é–‹</div>
							<div class="description">æ‰€æœ‰äººéƒ½å¯ä»¥è§€çœ‹</div>
						</label>
						<label class="privacy-option" data-value="Unlisted">
							<input type="radio" name="privacy" value="Unlisted">
							<div class="icon">ğŸ”—</div>
							<div class="label">ä¸å…¬é–‹åˆ—å‡º</div>
							<div class="description">æœ‰é€£çµçš„äººå¯ä»¥è§€çœ‹</div>
						</label>
						<label class="privacy-option" data-value="Private">
							<input type="radio" name="privacy" value="Private">
							<div class="icon">ğŸ”’</div>
							<div class="label">ç§äºº</div>
							<div class="description">åªæœ‰æ‚¨å¯ä»¥è§€çœ‹</div>
						</label>
					</div>
				</div>
			</div>
		</div>

		<!-- æ“ä½œæŒ‰éˆ• -->
		<div class="action-buttons">
			<button class="btn btn-secondary" id="saveDraftBtn" disabled>å„²å­˜è‰ç¨¿</button>
			<button class="btn btn-primary" id="publishBtn" disabled>ç™¼ä½ˆå½±ç‰‡</button>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		let currentVideoId = null;
		let uploadState = {
			isUploading: false,
			isPublished: false,
			hasUnsavedChanges: false
		};
		let uploadXHR = null;
		let selectedThumbnailUrl = null;
		const channelId = 1;

		// ========== é é¢è¼‰å…¥åˆå§‹åŒ– ==========
		document.addEventListener('DOMContentLoaded', function() {
			// éš±ç§é¸é …åˆ‡æ›
			document.querySelectorAll('.privacy-option').forEach(option => {
				option.addEventListener('click', function() {
					document.querySelectorAll('.privacy-option').forEach(opt => opt.classList.remove('selected'));
					this.classList.add('selected');
					this.querySelector('input[type="radio"]').checked = true;
					uploadState.hasUnsavedChanges = true;
				});
			});

			// æ¨™é¡Œå­—æ•¸çµ±è¨ˆ
			document.getElementById('videoTitle').addEventListener('input', function() {
				const small = this.parentElement.querySelector('small');
				small.textContent = `${this.value.length}/100 å­—å…ƒ`;
				uploadState.hasUnsavedChanges = true;
			});

			// æè¿°å­—æ•¸çµ±è¨ˆ
			document.getElementById('videoDescription').addEventListener('input', function() {
				const small = this.parentElement.querySelector('small');
				small.textContent = `${this.value.length}/5000 å­—å…ƒ`;
				uploadState.hasUnsavedChanges = true;
			});

			// è‡ªè¨‚ç¸®åœ–ä¸Šå‚³
			document.getElementById('customThumbnailInput').addEventListener('change', function(e) {
				const file = e.target.files[0];
				if (file) {
					handleCustomThumbnail(file);
				}
			});
		});

		// ========== é›¢é–‹é é¢æª¢æ¸¬ ==========
		window.addEventListener('beforeunload', function(e) {
			if (uploadState.isUploading || (currentVideoId && !uploadState.isPublished)) {
				e.preventDefault();
				e.returnValue = 'å½±ç‰‡å°šæœªç™¼ä½ˆï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
				return e.returnValue;
			}
		});

		window.addEventListener('unload', async function() {
			if (currentVideoId && !uploadState.isPublished) {
				const token = getAntiForgeryToken();
				const data = JSON.stringify({ videoId: currentVideoId });
				navigator.sendBeacon('/Videos/Videos/DeleteDraft', data);
			}
		});

		// ========== ç²å– Anti-Forgery Token ==========
		function getAntiForgeryToken() {
			const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
			return tokenInput ? tokenInput.value : '';
		}

		// ========== æª”æ¡ˆé¸æ“‡äº‹ä»¶ ==========
		document.getElementById('fileInput').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (file) {
				handleFileUpload(file);
			}
		});

		// ========== æ‹–æ”¾åŠŸèƒ½ ==========
		const uploadContainer = document.getElementById('uploadContainer');

		uploadContainer.addEventListener('dragover', function(e) {
			e.preventDefault();
			uploadContainer.classList.add('dragover');
		});

		uploadContainer.addEventListener('dragleave', function(e) {
			e.preventDefault();
			uploadContainer.classList.remove('dragover');
		});

		uploadContainer.addEventListener('drop', function(e) {
			e.preventDefault();
			uploadContainer.classList.remove('dragover');
			const file = e.dataTransfer.files[0];
			if (file && file.type.startsWith('video/')) {
				handleFileUpload(file);
			} else {
				showStatus('è«‹ä¸Šå‚³å½±ç‰‡æª”æ¡ˆ', 'error');
			}
		});

		// ========== è™•ç†æª”æ¡ˆä¸Šå‚³ ==========
		async function handleFileUpload(file) {
			if (file.size > 500 * 1024 * 1024) {
				showStatus('æª”æ¡ˆéå¤§ï¼Œæœ€å¤§æ”¯æ´ 500MB', 'error');
				return;
			}

			if (!file.type.startsWith('video/')) {
				showStatus('è«‹é¸æ“‡å½±ç‰‡æª”æ¡ˆ', 'error');
				return;
			}

			try {
				uploadState.isUploading = true;
				uploadState.isPublished = false;
				showWarningBanner(true);

				showStatus('æ­£åœ¨å»ºç«‹è‰ç¨¿...', 'info');
				currentVideoId = await createDraft();

				showStatus('æ­£åœ¨ä¸Šå‚³å½±ç‰‡...', 'info');
				document.getElementById('progressContainer').style.display = 'block';

				const uploadResult = await uploadVideoFile(currentVideoId, file);

				uploadState.isUploading = false;
				uploadState.hasUnsavedChanges = true;
				showWarningBanner(false);

				if (uploadResult.success) {
					showStatus('å½±ç‰‡ä¸Šå‚³æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆç¸®åœ–...', 'success');

					displayVideoPreview(uploadResult.filePath);

					// ç”Ÿæˆç¸®åœ–
					await generateThumbnails(uploadResult.filePath);

					document.getElementById('publishBtn').disabled = false;
					document.getElementById('saveDraftBtn').disabled = false;
				} else {
					throw new Error(uploadResult.message || 'ä¸Šå‚³å¤±æ•—');
				}
			} catch (error) {
				console.error('Upload error:', error);
				uploadState.isUploading = false;
				showWarningBanner(false);
				showStatus(`ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
				document.getElementById('progressContainer').style.display = 'none';

				if (currentVideoId) {
					await deleteDraft(currentVideoId);
					currentVideoId = null;
				}
			}
		}

		// ========== ç”Ÿæˆç¸®åœ– ==========
		async function generateThumbnails(videoUrl) {
			const video = document.getElementById('previewVideo');
			const thumbnailOptions = document.getElementById('thumbnailOptions');
			thumbnailOptions.innerHTML = '';

			// ç­‰å¾…å½±ç‰‡è¼‰å…¥å®Œæˆ
			await new Promise((resolve) => {
				if (video.readyState >= 2) {
					resolve();
				} else {
					video.addEventListener('loadeddata', resolve, { once: true });
				}
			});

			const duration = video.duration;
			const timestamps = [
				duration * 0.1,
				duration * 0.3,
				duration * 0.5,
				duration * 0.7,
				duration * 0.9
			];

			for (let i = 0; i < timestamps.length; i++) {
				const canvas = document.createElement('canvas');
				const ctx = canvas.getContext('2d');

				video.currentTime = timestamps[i];
				await new Promise(resolve => {
					video.addEventListener('seeked', resolve, { once: true });
				});

				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				ctx.drawImage(video, 0, 0);

				const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8);

				const thumbnailDiv = document.createElement('div');
				thumbnailDiv.className = 'thumbnail-item' + (i === 2 ? ' selected' : '');
				thumbnailDiv.innerHTML = `
					<img src="${thumbnailUrl}" alt="ç¸®åœ– ${i + 1}">
					<div class="check-icon">âœ“</div>
				`;
				thumbnailDiv.addEventListener('click', function() {
					selectThumbnail(this, thumbnailUrl);
				});

				thumbnailOptions.appendChild(thumbnailDiv);

				if (i === 2) {
					selectedThumbnailUrl = thumbnailUrl;
				}
			}

			// æ·»åŠ è‡ªè¨‚ä¸Šå‚³é¸é …
			const customUploadDiv = document.createElement('div');
			customUploadDiv.className = 'custom-thumbnail-upload';
			customUploadDiv.innerHTML = `
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
				</svg>
				<span>ä¸Šå‚³è‡ªè¨‚ç¸®åœ–</span>
			`;
			customUploadDiv.addEventListener('click', function() {
				document.getElementById('customThumbnailInput').click();
			});

			thumbnailOptions.appendChild(customUploadDiv);
		}

		// ========== é¸æ“‡ç¸®åœ– ==========
		function selectThumbnail(element, thumbnailUrl) {
			document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('selected'));
			element.classList.add('selected');
			selectedThumbnailUrl = thumbnailUrl;
			uploadState.hasUnsavedChanges = true;
		}

		// ========== è™•ç†è‡ªè¨‚ç¸®åœ– ==========
		async function handleCustomThumbnail(file) {
			if (!file.type.startsWith('image/')) {
				alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
				return;
			}

			if (file.size > 2 * 1024 * 1024) {
				alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 2MB');
				return;
			}

			const reader = new FileReader();
			reader.onload = function(e) {
				const thumbnailUrl = e.target.result;
				const thumbnailOptions = document.getElementById('thumbnailOptions');

				// ç§»é™¤ä¹‹å‰çš„è‡ªè¨‚ç¸®åœ–
				const existingCustom = thumbnailOptions.querySelector('.thumbnail-item[data-custom="true"]');
				if (existingCustom) {
					existingCustom.remove();
				}

				// æ·»åŠ æ–°çš„è‡ªè¨‚ç¸®åœ–
				const customUpload = thumbnailOptions.querySelector('.custom-thumbnail-upload');
				const thumbnailDiv = document.createElement('div');
				thumbnailDiv.className = 'thumbnail-item selected';
				thumbnailDiv.setAttribute('data-custom', 'true');
				thumbnailDiv.innerHTML = `
					<img src="${thumbnailUrl}" alt="è‡ªè¨‚ç¸®åœ–">
					<div class="check-icon">âœ“</div>
				`;
				thumbnailDiv.addEventListener('click', function() {
					selectThumbnail(this, thumbnailUrl);
				});

				thumbnailOptions.insertBefore(thumbnailDiv, customUpload);

				// å–æ¶ˆå…¶ä»–ç¸®åœ–çš„é¸ä¸­ç‹€æ…‹
				document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('selected'));
				thumbnailDiv.classList.add('selected');
				selectedThumbnailUrl = thumbnailUrl;
				uploadState.hasUnsavedChanges = true;
			};
			reader.readAsDataURL(file);
		}

		// ========== é¡¯ç¤º/éš±è—è­¦å‘Šæ©«å¹… ==========
		function showWarningBanner(show) {
			const banner = document.getElementById('warningBanner');
			banner.style.display = show ? 'block' : 'none';
		}

		// ========== å»ºç«‹è‰ç¨¿ ==========
		async function createDraft() {
			const token = getAntiForgeryToken();

			const response = await fetch('/Videos/Videos/CreateDraft', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
					'RequestVerificationToken': token
				},
				body: `channelId=${channelId}&__RequestVerificationToken=${encodeURIComponent(token)}`
			});

			if (!response.ok) {
				const text = await response.text();
				throw new Error(`HTTP ${response.status}: ${text}`);
			}

			const data = await response.json();
			return data.videoId;
		}

		// ========== ä¸Šå‚³å½±ç‰‡æª”æ¡ˆ ==========
		function uploadVideoFile(videoId, file) {
			return new Promise((resolve, reject) => {
				const formData = new FormData();
				formData.append('videoFile', file);

				const token = getAntiForgeryToken();
				uploadXHR = new XMLHttpRequest();

				uploadXHR.upload.addEventListener('progress', function(e) {
					if (e.lengthComputable) {
						const percentComplete = Math.round((e.loaded / e.total) * 100);
						updateProgress(percentComplete);
					}
				});

				uploadXHR.addEventListener('load', function() {
					if (uploadXHR.status === 200) {
						try {
							const result = JSON.parse(uploadXHR.responseText);
							resolve(result);
						} catch (e) {
							reject(new Error('ç„¡æ³•è§£æä¼ºæœå™¨å›æ‡‰'));
						}
					} else {
						reject(new Error(`Upload failed, status: ${uploadXHR.status}`));
					}
					uploadXHR = null;
				});

				uploadXHR.addEventListener('error', function() {
					reject(new Error('ç¶²è·¯éŒ¯èª¤'));
					uploadXHR = null;
				});

				uploadXHR.addEventListener('abort', function() {
					reject(new Error('ä¸Šå‚³å·²å–æ¶ˆ'));
					uploadXHR = null;
				});

				uploadXHR.open('POST', `/Videos/Videos/UploadFile?videoId=${videoId}`);
				uploadXHR.setRequestHeader('RequestVerificationToken', token);
				uploadXHR.send(formData);
			});
		}

		// ========== æ›´æ–°é€²åº¦æ¢ ==========
		function updateProgress(percent) {
			const progressFill = document.getElementById('progressFill');
			progressFill.style.width = percent + '%';
			progressFill.textContent = percent + '%';
		}

		// ========== é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ ==========
		function showStatus(message, type) {
			const statusDiv = document.getElementById('statusMessage');
			statusDiv.textContent = message;
			statusDiv.className = 'status-message status-' + type;
		}

		// ========== é¡¯ç¤ºå½±ç‰‡é è¦½ ==========
		function displayVideoPreview(videoUrl) {
			const previewSection = document.getElementById('videoPreviewSection');
			const previewVideo = document.getElementById('previewVideo');
			previewVideo.src = videoUrl;
			previewSection.style.display = 'block';

			// éš±è—ä¸Šå‚³å€åŸŸ
			document.getElementById('uploadContainer').style.display = 'none';
		}

		// ========== å„²å­˜è‰ç¨¿æŒ‰éˆ• ==========
		document.getElementById('saveDraftBtn').addEventListener('click', async function() {
			try {
				this.disabled = true;
				await saveVideoData(false);
				showStatus('è‰ç¨¿å·²å„²å­˜', 'success');
				uploadState.hasUnsavedChanges = false;
				this.disabled = false;
			} catch (error) {
				showStatus(`å„²å­˜å¤±æ•—: ${error.message}`, 'error');
				this.disabled = false;
			}
		});

		// ========== ç™¼ä½ˆå½±ç‰‡æŒ‰éˆ• ==========
		document.getElementById('publishBtn').addEventListener('click', async function() {
			const title = document.getElementById('videoTitle').value.trim();

			if (!title) {
				alert('è«‹è¼¸å…¥å½±ç‰‡æ¨™é¡Œ');
				return;
			}

			try {
				this.disabled = true;
				document.getElementById('saveDraftBtn').disabled = true;

				await saveVideoData(true);

				uploadState.isPublished = true;
				uploadState.hasUnsavedChanges = false;
				showStatus('å½±ç‰‡ç™¼ä½ˆæˆåŠŸï¼æ­£åœ¨è·³è½‰...', 'success');

				setTimeout(() => {
					window.location.href = `/Videos/Videos/Details/${currentVideoId}`;
				}, 1500);
			} catch (error) {
				console.error('Publish error:', error);
				showStatus(`ç™¼ä½ˆå¤±æ•—: ${error.message}`, 'error');
				this.disabled = false;
				document.getElementById('saveDraftBtn').disabled = false;
			}
		});

		// ========== å„²å­˜å½±ç‰‡è³‡æ–™ ==========
		async function saveVideoData(publish) {
			const title = document.getElementById('videoTitle').value.trim();
			const description = document.getElementById('videoDescription').value.trim();
			const privacy = document.querySelector('input[name="privacy"]:checked').value;

			showStatus(publish ? 'æ­£åœ¨ç™¼ä½ˆå½±ç‰‡...' : 'æ­£åœ¨å„²å­˜è‰ç¨¿...', 'info');

			// æ›´æ–°å½±ç‰‡è³‡è¨Š
			await updateVideoInfo(currentVideoId, title, description, privacy);

			// ä¸Šå‚³ç¸®åœ–
			if (selectedThumbnailUrl) {
				await uploadThumbnail(currentVideoId, selectedThumbnailUrl);
			}

			// å¦‚æœæ˜¯ç™¼ä½ˆï¼Œå‰‡åŸ·è¡Œç™¼ä½ˆæ“ä½œ
			if (publish) {
				await publishVideo(currentVideoId);
			}
		}

		// ========== æ›´æ–°å½±ç‰‡è³‡è¨Š ==========
		async function updateVideoInfo(videoId, title, description, privacy) {
			const token = getAntiForgeryToken();

			const response = await fetch('/Videos/Videos/UpdateInfo', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'RequestVerificationToken': token
				},
				body: JSON.stringify({
					videoId: videoId,
					title: title,
					description: description,
					privacy: privacy
				})
			});

			if (!response.ok) {
				throw new Error(`æ›´æ–°è³‡è¨Šå¤±æ•—: ${response.status}`);
			}

			return await response.json();
		}

		// ========== ä¸Šå‚³ç¸®åœ– ==========
		async function uploadThumbnail(videoId, thumbnailDataUrl) {
			const token = getAntiForgeryToken();

			// å°‡ base64 è½‰æ›ç‚º Blob
			const blob = await fetch(thumbnailDataUrl).then(r => r.blob());

			const formData = new FormData();
			formData.append('thumbnail', blob, 'thumbnail.jpg');

			const response = await fetch(`/Videos/Videos/UploadThumbnail?videoId=${videoId}`, {
				method: 'POST',
				headers: {
					'RequestVerificationToken': token
				},
				body: formData
			});

			if (!response.ok) {
				console.error('ä¸Šå‚³ç¸®åœ–å¤±æ•—:', response.status);
				// ä¸é˜»æ­¢ç™¼ä½ˆæµç¨‹
			}

			return response.ok;
		}

		// ========== ç™¼ä½ˆå½±ç‰‡ ==========
		async function publishVideo(videoId) {
			const token = getAntiForgeryToken();

			const response = await fetch('/Videos/Videos/Publish', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'RequestVerificationToken': token
				},
				body: JSON.stringify({
					videoId: videoId
				})
			});

			if (!response.ok) {
				throw new Error(`ç™¼ä½ˆå¤±æ•—: ${response.status}`);
			}

			return await response.json();
		}

		// ========== åˆªé™¤è‰ç¨¿ ==========
		async function deleteDraft(videoId) {
			try {
				const token = getAntiForgeryToken();

				const response = await fetch('/Videos/Videos/DeleteDraft', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token
					},
					body: JSON.stringify({ videoId: videoId })
				});

				if (response.ok) {
					console.log('è‰ç¨¿å·²åˆªé™¤:', videoId);
				} else {
					console.error('åˆªé™¤è‰ç¨¿å¤±æ•—:', response.status);
				}
			} catch (error) {
				console.error('åˆªé™¤è‰ç¨¿éŒ¯èª¤:', error);
			}
		}
	</script>
}
