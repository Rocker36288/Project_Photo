@model Project_Photo.Models.UserRoleType
@{
    ViewData["Title"] = "編輯角色類型";
}

@section Styles {
    <style>
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .required::after {
            content: " *";
            color: #d63939;
        }

        .form-text {
            font-size: 0.875rem;
            color: #64748b;
        }

        .readonly-field {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
    </style>
}

<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    編輯角色類型
                </h2>
                <div class="text-muted mt-1">@Model.RoleName (@Model.RoleCode)</div>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <a asp-action="Details" asp-route-id="@Model.RoleTypeId" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M5 12l14 0" />
                            <path d="M5 12l6 6" />
                            <path d="M5 12l6 -6" />
                        </svg>
                        返回詳情
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <div class="row row-cards">
            <div class="col-12">
                <form asp-action="Edit" method="post">
                    <input type="hidden" asp-for="RoleTypeId" />
                    <input type="hidden" asp-for="CreatedAt" />

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">角色類型資訊</h3>
                        </div>
                        <div class="card-body">
                            @if (!ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <div class="d-flex">
                                        <div>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <circle cx="12" cy="12" r="9" />
                                                <line x1="12" y1="8" x2="12" y2="12" />
                                                <line x1="12" y1="16" x2="12.01" y2="16" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="alert-title">發生錯誤</h4>
                                            <div class="text-muted">
                                                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
                                </div>
                            }

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="RoleTypeId" class="form-label">角色ID</label>
                                        <input asp-for="RoleTypeId" class="form-control readonly-field" readonly />
                                        <small class="form-text">角色ID無法修改</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="RoleCode" class="form-label required">角色代碼</label>
                                        <input asp-for="RoleCode" class="form-control" placeholder="例如: SUPER_ADMIN" maxlength="50" />
                                        <small class="form-text">請使用英文大寫和底線，建議格式: XXX_ADMIN</small>
                                        <span asp-validation-for="RoleCode" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="RoleName" class="form-label required">角色名稱</label>
                                <input asp-for="RoleName" class="form-control" placeholder="例如: 超級管理員" maxlength="100" />
                                <small class="form-text">請輸入角色的中文名稱</small>
                                <span asp-validation-for="RoleName" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="RoleDescription" class="form-label">角色說明</label>
                                <textarea asp-for="RoleDescription" class="form-control" rows="4" placeholder="請輸入此角色的權限範圍與功能說明..." maxlength="200"></textarea>
                                <small class="form-text">最多 200 個字元，用於說明此角色的權限範圍</small>
                                <span asp-validation-for="RoleDescription" class="text-danger"></span>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="RoleLevel" class="form-label required">角色層級</label>
                                        <select asp-for="RoleLevel" class="form-select">
                                            <option value="1">1 - 超級管理員</option>
                                            <option value="2">2 - 系統管理員</option>
                                            <option value="3">3 - 特殊角色</option>
                                            <option value="4">4 - 一般用戶</option>
                                        </select>
                                        <small class="form-text">層級越低權限越高，1為最高權限</small>
                                        <span asp-validation-for="RoleLevel" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="SystemId" class="form-label">所屬系統</label>
                                        <select asp-for="SystemId" class="form-select">
                                            <option value="">無（跨系統角色）</option>
                                            @if (ViewBag.SystemList != null)
                                            {
                                                @foreach (var system in ViewBag.SystemList)
                                                {
                                                    <option value="@system.SystemId">@system.SystemName</option>
                                                }
                                            }
                                        </select>
                                        <small class="form-text">選擇此角色歸屬的系統，留空表示跨系統角色</small>
                                        <span asp-validation-for="SystemId" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">狀態</label>
                                <div>
                                    <label class="form-check form-check-inline">
                                        <input asp-for="IsActive" class="form-check-input" type="radio" value="true" />
                                        <span class="form-check-label">啟用</span>
                                    </label>
                                    <label class="form-check form-check-inline">
                                        <input asp-for="IsActive" class="form-check-input" type="radio" value="false" />
                                        <span class="form-check-label">停用</span>
                                    </label>
                                </div>
                                <small class="form-text">停用後，此角色將無法被分配給用戶</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="CreatedAt" class="form-label">建立時間</label>
                                        <input type="text" class="form-control readonly-field" value="@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")" readonly />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="UpdatedAt" class="form-label">最後更新</label>
                                        <input type="text" class="form-control readonly-field" value="@Model.UpdatedAt.ToString("yyyy-MM-dd HH:mm:ss")" readonly />
                                        <small class="form-text">儲存後將自動更新此時間</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-end">
                            <div class="d-flex">
                                <a asp-action="Details" asp-route-id="@Model.RoleTypeId" class="btn btn-link">取消</a>
                                <button type="submit" class="btn btn-primary ms-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                                        <circle cx="12" cy="14" r="2" />
                                        <polyline points="14 4 14 8 8 8 8 4" />
                                    </svg>
                                    儲存變更
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 警告提示 -->
        <div class="row row-cards mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-yellow-lt">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-yellow" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M12 9v2m0 4v.01" />
                                <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75" />
                            </svg>
                            編輯注意事項
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="mb-3 text-yellow">
                                    <i class="ti ti-alert-triangle me-2"></i>
                                    修改角色代碼的影響
                                </h4>
                                <p class="text-muted">
                                    修改角色代碼可能會影響系統中已分配此角色的用戶。
                                    建議在角色建立前確定好代碼，建立後應避免修改。
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h4 class="mb-3 text-yellow">
                                    <i class="ti ti-alert-triangle me-2"></i>
                                    停用角色的影響
                                </h4>
                                <p class="text-muted">
                                    停用角色後，擁有此角色的用戶將失去相應的系統權限。
                                    停用前請確認影響範圍，必要時請先移除用戶的角色。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // 表單驗證提示
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');
            const roleCodeInput = document.querySelector('#RoleCode');
            const roleNameInput = document.querySelector('#RoleName');
            const isActiveRadios = document.querySelectorAll('input[name="IsActive"]');

            const originalRoleCode = roleCodeInput.value;
            const originalIsActive = document.querySelector('input[name="IsActive"]:checked')?.value === 'true';

            // 角色代碼格式驗證
            if (roleCodeInput) {
                roleCodeInput.addEventListener('input', function (e) {
                    // 自動轉換為大寫
                    e.target.value = e.target.value.toUpperCase();

                    // 只允許英文字母、數字和底線
                    e.target.value = e.target.value.replace(/[^A-Z0-9_]/g, '');
                });
            }

            // 表單提交前確認
            form.addEventListener('submit', function (e) {
                const roleCode = roleCodeInput.value.trim();
                const roleName = roleNameInput.value.trim();
                const currentIsActive = document.querySelector('input[name="IsActive"]:checked')?.value === 'true';

                if (!roleCode || !roleName) {
                    e.preventDefault();
                    alert('請填寫必填欄位');
                    return false;
                }

                // 如果修改了角色代碼，顯示警告
                if (roleCode !== originalRoleCode) {
                    if (!confirm('警告：修改角色代碼可能會影響已分配此角色的用戶。確定要修改嗎？')) {
                        e.preventDefault();
                        return false;
                    }
                }

                // 如果將角色停用，顯示警告
                if (originalIsActive && !currentIsActive) {
                    if (!confirm('警告：停用此角色後，所有擁有此角色的用戶將失去相應權限。確定要停用嗎？')) {
                        e.preventDefault();
                        return false;
                    }
                }
            });
        });
    </script>
}
